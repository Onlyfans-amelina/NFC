<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestionnaire Firestore en Temps Réel</title>
  <!-- Inclusion de Bootstrap pour la mise en forme -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    /* Styles personnalisés */
    .modal {
      display: none; /* Masqué par défaut */
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-dialog {
      margin: 10% auto;
      max-width: 600px;
      background: #fff;
      padding: 20px;
      border-radius: 5px;
    }
    .mr-2 {
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <!-- CONTAINER DE CONNEXION -->
  <div id="login-container" class="container mt-5">
    <h2>Connexion</h2>
    <form id="login-form">
      <div class="form-group">
        <label for="email">Email :</label>
        <input type="email" class="form-control" id="email" required>
      </div>
      <div class="form-group">
        <label for="password">Mot de passe :</label>
        <input type="password" class="form-control" id="password" required>
      </div>
      <button type="submit" class="btn btn-primary">Se connecter</button>
    </form>
  </div>

  <!-- CONTAINER PRINCIPAL (Masqué tant que l'utilisateur n'est pas connecté) -->
  <div id="main-container" class="container mt-5" style="display: none;">
    <h1>Gestionnaire Firestore</h1>
    <!-- Liste des collections disponibles -->
    <div id="collections-list">
      <h2>Collections</h2>
      <ul class="list-group">
        <li class="list-group-item">
          <a href="#" class="collection-link" data-collection="users">Users</a>
        </li>
        <li class="list-group-item">
          <a href="#" class="collection-link" data-collection="tags">Tags</a>
        </li>
        <li class="list-group-item">
          <a href="#" class="collection-link" data-collection="photos">Photos</a>
        </li>
        <li class="list-group-item">
          <a href="#" class="collection-link" data-collection="chasses">Chasses</a>
        </li>
      </ul>
    </div>

    <!-- Détails d'une collection (affichage des documents) -->
    <div id="collection-details" style="margin-top: 20px; display:none;">
      <h2 id="collection-title"></h2>
      <!-- Bouton pour ajouter une nouvelle entrée -->
      <button id="add-entry-btn" class="btn btn-success mb-3">Ajouter une entrée</button>
      <!-- Tableau listant les documents -->
      <table class="table table-bordered">
        <thead>
          <tr id="table-header">
            <!-- Rempli dynamiquement -->
          </tr>
        </thead>
        <tbody id="table-body">
          <!-- Rempli dynamiquement -->
        </tbody>
      </table>
      <!-- Bouton pour revenir à la liste des collections -->
      <button id="back-btn" class="btn btn-secondary">Retour</button>
    </div>
  </div>

  <!-- MODAL POUR AJOUTER / MODIFIER UNE ENTRÉE -->
  <div id="entry-modal" class="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modal-title">Ajouter une entrée</h5>
          <button type="button" class="close" id="close-modal-btn" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Formulaire dynamique pour saisir les champs du document -->
          <form id="entry-form">
            <div id="dynamic-fields">
              <!-- Un ensemble initial de champs sera ajouté dynamiquement -->
            </div>
            <!-- Bouton pour ajouter des champs dynamiques (clé/valeur) -->
            <button type="button" class="btn btn-info" id="add-field-btn">Ajouter un champ</button>
            <br><br>
            <button type="submit" class="btn btn-primary" id="save-entry-btn">Enregistrer</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Inclusion des SDK Firebase en mode module -->
  <script type="module">
    // Importation des fonctions nécessaires depuis Firebase (version 9+)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

    // ====================================================
    // 1. Configuration Firebase
    // Remplacez les valeurs ci-dessous par celles de votre projet Firebase.
    // ====================================================
    const firebaseConfig = {
    apiKey: "AIzaSyCLQMSzHNiOfXD-umi194rayB3-T0_0ekQ",
    authDomain: "amelina-a6063.firebaseapp.com",
    databaseURL: "https://amelina-a6063-default-rtdb.firebaseio.com",
    projectId: "amelina-a6063",
    storageBucket: "amelina-a6063.firebasestorage.app",
    messagingSenderId: "221285415211",
    appId: "1:221285415211:web:1db56bcfe7e3305de02d6e"
    };

    // Initialisation de Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ====================================================
    // 2. Références aux éléments HTML
    // ====================================================
    const loginContainer = document.getElementById("login-container");
    const mainContainer = document.getElementById("main-container");
    const loginForm = document.getElementById("login-form");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const collectionsList = document.getElementById("collections-list");
    const collectionDetails = document.getElementById("collection-details");
    const collectionTitle = document.getElementById("collection-title");
    const tableHeader = document.getElementById("table-header");
    const tableBody = document.getElementById("table-body");
    const backBtn = document.getElementById("back-btn");
    const addEntryBtn = document.getElementById("add-entry-btn");
    const entryModal = document.getElementById("entry-modal");
    const closeModalBtn = document.getElementById("close-modal-btn");
    const entryForm = document.getElementById("entry-form");
    const dynamicFields = document.getElementById("dynamic-fields");
    const addFieldBtn = document.getElementById("add-field-btn");
    const modalTitle = document.getElementById("modal-title");

    // Variable pour gérer l'écouteur en temps réel
    let unsubscribe = null;

    // Variables globales pour la gestion de l'état
    let currentCollection = ""; // Collection actuellement affichée
    let currentDocId = null;    // Document en cours d'édition (null = ajout)
    let fieldCounter = 0;       // Compteur pour les champs dynamiques

    // ====================================================
    // 3. Authentification Firebase
    // ====================================================
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // L'utilisateur est connecté : affichage du gestionnaire
        loginContainer.style.display = "none";
        mainContainer.style.display = "block";
      } else {
        // L'utilisateur n'est pas connecté : affichage de la page de connexion
        loginContainer.style.display = "block";
        mainContainer.style.display = "none";
      }
    });

    // Gestion de la soumission du formulaire de connexion
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = emailInput.value;
      const password = passwordInput.value;
      // Connexion via Firebase Authentication (Email/Password)
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          console.log("Utilisateur connecté :", userCredential.user);
          loginForm.reset();
        })
        .catch((error) => {
          console.error("Erreur de connexion :", error);
          alert("Erreur de connexion : " + error.message);
        });
    });

    // ====================================================
    // 4. Navigation entre la liste des collections et les documents
    // ====================================================
    // Pour chaque lien de collection, on active un écouteur en temps réel pour charger les documents
    document.querySelectorAll(".collection-link").forEach(link => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        currentCollection = e.target.getAttribute("data-collection");
        collectionTitle.textContent = "Collection : " + currentCollection;
        // Masquer la liste des collections et afficher les détails
        collectionsList.style.display = "none";
        collectionDetails.style.display = "block";
        // Charger la collection en temps réel
        loadCollection(currentCollection);
      });
    });

    // Bouton "Retour" pour revenir à la liste des collections
    backBtn.addEventListener("click", () => {
      collectionDetails.style.display = "none";
      collectionsList.style.display = "block";
      tableHeader.innerHTML = "";
      tableBody.innerHTML = "";
      // Se désabonner de l'écouteur de la collection
      if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
      }
    });

    // ====================================================
    // 5. Fonction pour charger une collection en temps réel
    // ====================================================
    function loadCollection(collectionName) {
      // Se désabonner de l'écouteur précédent s'il existe
      if (unsubscribe) {
        unsubscribe();
      }
      // Mettre en place l'écouteur en temps réel sur la collection
      unsubscribe = onSnapshot(collection(db, collectionName), (querySnapshot) => {
        // Réinitialisation de l'affichage
        tableHeader.innerHTML = "";
        tableBody.innerHTML = "";
        let keys = new Set();
        const docsData = [];
        // Récupérer les données de chaque document et extraire les clés
        querySnapshot.forEach((docSnap) => {
          const data = docSnap.data();
          data.id = docSnap.id; // Ajout de l'ID du document
          docsData.push(data);
          Object.keys(data).forEach(key => keys.add(key));
        });
        // Création de l'en-tête du tableau
        keys = Array.from(keys);
        keys.unshift("id");
        keys.push("Actions");
        keys.forEach(key => {
          const th = document.createElement("th");
          th.textContent = key;
          tableHeader.appendChild(th);
        });
        // Remplissage des lignes du tableau
        docsData.forEach(docData => {
          const tr = document.createElement("tr");
          keys.forEach(key => {
            const td = document.createElement("td");
            if (key === "Actions") {
              // Bouton Modifier
              const editBtn = document.createElement("button");
              editBtn.textContent = "Modifier";
              editBtn.className = "btn btn-sm btn-warning mr-2";
              editBtn.addEventListener("click", () => {
                openEditModal(docData);
              });
              // Bouton Supprimer
              const deleteBtn = document.createElement("button");
              deleteBtn.textContent = "Supprimer";
              deleteBtn.className = "btn btn-sm btn-danger";
              deleteBtn.addEventListener("click", () => {
                if (confirm("Êtes-vous sûr de vouloir supprimer ce document ?")) {
                  deleteDocument(currentCollection, docData.id);
                }
              });
              td.appendChild(editBtn);
              td.appendChild(deleteBtn);
            } else {
              td.textContent = docData[key] !== undefined ? docData[key] : "";
            }
            tr.appendChild(td);
          });
          tableBody.appendChild(tr);
        });
      }, (error) => {
        console.error("Erreur lors de l'écoute en temps réel :", error);
        alert("Erreur lors du chargement de la collection : " + error.message);
      });
    }

    // ====================================================
    // 6. Suppression d'un document
    // ====================================================
    async function deleteDocument(collectionName, docId) {
      try {
        await deleteDoc(doc(db, collectionName, docId));
        alert("Document supprimé avec succès.");
        // La mise à jour de l'affichage se fait automatiquement grâce à onSnapshot.
      } catch (error) {
        console.error("Erreur lors de la suppression du document :", error);
        alert("Erreur lors de la suppression du document : " + error.message);
      }
    }

    // ====================================================
    // 7. Gestion du Modal pour l'ajout / la modification
    // ====================================================
    // Ouvrir le modal pour ajouter une nouvelle entrée
    addEntryBtn.addEventListener("click", () => {
      currentDocId = null; // Aucun document n'est en cours d'édition
      modalTitle.textContent = "Ajouter une entrée";
      dynamicFields.innerHTML = "";
      fieldCounter = 0;
      addDynamicField(); // Ajout d'un premier champ
      entryModal.style.display = "block";
    });

    // Fermeture du modal via le bouton "×"
    closeModalBtn.addEventListener("click", () => {
      entryModal.style.display = "none";
    });

    // Fonction pour ajouter un champ dynamique (clé/valeur)
    function addDynamicField(key = "", value = "") {
      // Création d'un groupe pour la clé
      const divKey = document.createElement("div");
      divKey.className = "form-group";
      const labelKey = document.createElement("label");
      labelKey.textContent = "Clé :";
      labelKey.setAttribute("for", "field-key-" + fieldCounter);
      const inputKey = document.createElement("input");
      inputKey.type = "text";
      inputKey.className = "form-control";
      inputKey.id = "field-key-" + fieldCounter;
      inputKey.value = key;
      
      // Création d'un groupe pour la valeur
      const divValue = document.createElement("div");
      divValue.className = "form-group";
      const labelValue = document.createElement("label");
      labelValue.textContent = "Valeur :";
      labelValue.setAttribute("for", "field-value-" + fieldCounter);
      const inputValue = document.createElement("input");
      inputValue.type = "text";
      inputValue.className = "form-control";
      inputValue.id = "field-value-" + fieldCounter;
      inputValue.value = value;

      // Ajout des éléments dans le conteneur
      dynamicFields.appendChild(divKey);
      divKey.appendChild(labelKey);
      divKey.appendChild(inputKey);
      dynamicFields.appendChild(divValue);
      divValue.appendChild(labelValue);
      divValue.appendChild(inputValue);

      fieldCounter++;
    }

    // Bouton pour ajouter un nouveau champ dans le formulaire
    addFieldBtn.addEventListener("click", () => {
      addDynamicField();
    });

    // Gestion de la soumission du formulaire (ajout ou modification)
    entryForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      // Récupération des données saisies
      const data = {};
      for (let i = 0; i < fieldCounter; i++) {
        const keyInput = document.getElementById("field-key-" + i);
        const valueInput = document.getElementById("field-value-" + i);
        if(keyInput && valueInput) {
          const key = keyInput.value.trim();
          const value = valueInput.value.trim();
          if(key !== "") {
            // Conversion en nombre si possible
            if(!isNaN(value) && value !== "") {
              data[key] = Number(value);
            } else {
              data[key] = value;
            }
          }
        }
      }
      try {
        if(currentDocId) {
          // Mode édition
          const docRef = doc(db, currentCollection, currentDocId);
          await updateDoc(docRef, data);
          alert("Document mis à jour avec succès.");
        } else {
          // Mode ajout
          await addDoc(collection(db, currentCollection), data);
          alert("Document ajouté avec succès.");
        }
        entryModal.style.display = "none";
        // La mise à jour se fait automatiquement via onSnapshot.
      } catch (error) {
        console.error("Erreur lors de l'enregistrement du document :", error);
        alert("Erreur lors de l'enregistrement du document : " + error.message);
      }
    });

    // Fonction d'ouverture du modal en mode édition (pré-remplissage des champs)
    function openEditModal(docData) {
      currentDocId = docData.id;
      modalTitle.textContent = "Modifier l'entrée";
      dynamicFields.innerHTML = "";
      fieldCounter = 0;
      // Pour chaque champ du document (sauf l'ID), on crée un champ dynamique
      for (const key in docData) {
        if (key === "id") continue;
        addDynamicField(key, docData[key]);
      }
      entryModal.style.display = "block";
    }

    // Fermeture du modal si l'utilisateur clique en dehors du contenu
    window.onclick = function(event) {
      if (event.target === entryModal) {
        entryModal.style.display = "none";
      }
    }
  </script>
</body>
</html>
